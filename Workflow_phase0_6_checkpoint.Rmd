---
title: "Whale Shark Movement Project"
subtitle: "Phase 0–6 Methods Workflow"
author: "Madelyne Zhang"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    number_sections: true
    toc: true
    toc_depth: 3
    toc_float: true
    theme: flatly
    highlight: pygments
---

# Purpose and scope of this document

**Purpose**

This document walks through the workflow and decision-making process for Phases 0–6 of the whale shark movement project, with an emphasis on model selection, sanity checks, diagnostics, and how model failures were identified and addressed.

**Scope**

1.  Raw data assessment
2.  State-space model fitting and diagnostics
3.  Move persistence modelling
4.  Data extraction and Mapping

# Phase 0: Project framing and modelling strategy

## Project objective

The overall goal of this project is to use state-space movement models to infer more realistic whale shark movement paths from irregular satellite tracking data, and to later examine how environmental conditions, such as sea surface temperature, relate to movement persistence and spatial behaviour.

In particular, this project aims to:

-   Reconstruct continuous whale shark movement trajectories from irregular and error-prone telemetry Argos observations

-   Describe behavioural variation along the reconstructed tracks using continuous movement persistence rather than discrete states

-   Produce a clean, analysis-ready movement dataset that can be linked to environmental data in later stages

## Project Plan and Modelling Approach

The project is designed as a two-stage workflow.

In the first stage, state-space movement models are used to recover latent shark locations from observed satellite tracking data. The move persistence modelling framework implemented in the aniMotum package is applied, together with a biologically reasonable maximum velocity constraint, to limit the influence of extreme observation errors. This step produces predicted shark locations on a regular time grid, along with associated uncertainty estimates.

In the second stage, the reconstructed tracks are intended to be combined with environmental data, such as sea surface temperature, through spatial and temporal matching with gridded raster products. Environmental covariates can then be explored in relation to movement persistence and spatial patterns.

By separating movement reconstruction from environmental analysis, the workflow keeps behavioural estimates independent of environmental assumptions at an early stage.

## Modelling choices and scope of phase0 - phase6

The modelling choices in this project mainly come from two things: the structure of the satellite tracking data and the way whale sharks move. A state-space modelling framework is used to deal with location error and irregular sampling in the Argos data. Instead of filtering points manually, uncertainty in the observed locations is handled directly in the model during trajectory reconstruction. The aniMotum package is used because the focus here is on reconstructing continuous movement paths and describing behaviour along those paths. Movement persistence is used as the main behavioural measure. It gives a continuous summary of how consistent movement is in terms of speed and direction over time, which fits the goal of describing gradual behavioural changes and makes it easier to relate behaviour to continuous environmental variables later on. In this document, Phase 0–6 is focused on setting up and describing the movement modelling pipeline. This includes reconstructing tracks, running model diagnostics, estimating movement persistence, and preparing a clean movement dataset. Environmental variables are not included at this stage and will be added later.

# Phase 1: Raw data, sanity and exploratory checks

The goal of this phase is to understand the structure and quality of the raw Argos telemetry data before fitting any movement models. This includes sanity check, and the checking of temporal sampling, spatial behaviour.

As an initial check, the number of observations was summarised for each individual. The data contains 60 sharks. A small number of sharks(8) had fewer than three observations, which is not sufficient for fitting a state-space model. These individuals were excluded from further analysis. After this step, 52 sharks remained in the dataset. To understand the temporal structure of the data, time gaps between consecutive observations were calculated for each individual. Most observations were separated by short intervals, with a median gap of about 0.7 hours. At the same time, the data also contained very long gaps, in some cases extending to multiple years, with a maxium of around 2.9 years. Raw spatial tracks were plotted for each shark as a quick visual check. A simple velocity sanity check was then carried out by computing stepwise speeds between consecutive observations. The resulting speed distribution was strongly right-skewed, with approximately 12 percent of observed steps exceeding a biologically informed maximum swimming speed of 2.7 m/s. These extreme values could be caused by location error and long time gaps. Therefore, no hard filtering based on speed was applied and the implausible movements were handled later through a maximum velocity constraint in the state-space model.

Additional data consistency checks were performed to ensure the data were suitable for state-space modelling. These included removing records with invalid timestamps or missing coordinates, ordering observations within individuals, removing duplicated timestamps, and confirming that observation times increased strictly within each track. After cleaning, all remaining sharks had at least three valid observations with consistent timestamps and locations. The final cleaned dataset used for state-space modelling contained 52 sharks and 12,144 observations.

# Phase 2: State-Space Model fitting and track reconstruction

Model fitting was carried out using the fit_ssm function with a regularized time step of 24 hours and a maximum swimming speed of 2.7 m/s. The daily time step was chosen based on the temporal patterns identified in Phase 1, where short observation intervals were mixed with occasional multi-month to multi-year gaps. The maximum velocity constraint was used to limit the influence of implausible movements. After fitting the model, fitted locations at observation times and predicted locations at regular 24-hour intervals were extracted. Model convergence was checked using the reported convergence status.

Of the 52 sharks included in this step, two did not converge. These individuals were flagged and examined separately. Inspection of their observation histories showed that they had some of the largest time gaps in the dataset, consistent with patterns noted during the exploratory checks in Phase 1. These individuals were excluded from further analyses, leaving 50 sharks with valid state-space model fits.

Predicted tracks were then visualized for a small number of representative sharks, including individuals with very sparse observations, large temporal gaps, and more typical data coverage. Sharks with sparse data or long gaps showed large positional uncertainty during periods without observations and were not used for behavioural interpretation. In contrast, sharks with more regular observation patterns showed stable reconstructed tracks with reasonable uncertainty.

Finally, predicted tracks for all converged individuals were visualized together as a general check on the reconstructed movement patterns. At the end of this phase, a set of reconstructed tracks with associated uncertainty was available for subsequent diagnostic checks and behavioural modeling.

# Phase 3: State-Space Model Diagnostics

In this phase, diagnostic checks were used to evaluate the state-space model fits based on one-step-ahead residuals. Diagnostics were applied to a small set of representative individuals, including sharks with sparse observations, large temporal gaps, and more typical observation patterns. For each individual, residual time series, QQ plots, and autocorrelation function (ACF) plots were examined.

For the representative individuals, the diagnostic plots did not show major concerns. Residuals were generally centered around zero without strong systematic trends over time. QQ plots were broadly consistent with the assumed error structure, with only mild tail deviations. ACF plots showed little remaining autocorrelation, suggesting that temporal dependence in the movement process was adequately captured by the CRW model.

Because some individuals failed to converge in the move persistence model at later stages, additional diagnostics were carried out for those sharks to assess whether potential issues were already present at the state-space model stage. Individuals with large temporal gaps were examined in more detail.

For one such individual (id = 175953), the maximum gap between consecutive observations exceeded 2,300 hours. Despite this long gap, the diagnostic plots did not show clear departures from model assumptions. Residuals remained centered around zero, and autocorrelation was largely within expected bounds.

In contrast, another individual with large temporal gaps (id = 203646) showed less stable diagnostic behavior. The residual time series displayed noticeable changes over time, and the ACF plots suggested subtle differences between the x and y components. While the state-space model converged for this individual, these features indicate increased uncertainty that may affect further estimation of movement persistence.

Based on these diagnostics, state-space model fits were considered adequate for trajectory reconstruction. Individuals showing less stable residual behavior were flagged in later behavioral analyses.

# Phase 4: Move Persistence Model (MPM) fitting

In this phase, a move persistence model was fitted to the state-space model predicted locations in order to estimate continuous movement persistence over time. The model was fitted using the predicted (regularized) latent track points from the SSM output, which provide a regular time series of locations with associated uncertainty.

Before fitting the move persistence model, individuals with fewer than 20 predicted locations were excluded. This threshold was used to avoid fitting the model to extremely short tracks, where movement persistence estimates are typically unstable. After this filtering step, 35 sharks were retained for move persistence modelling.

The move persistence model was then fitted using fit_mpm with model = "mpm". Model convergence was checked from the fitted object. Among the 35 sharks included in this step, two individuals (175953 and 203646) failed to converge. These individuals were flagged and carried forward as non-converged cases, rather than being interpreted in the movement persistence results.

A basic plot of the fitted move persistence model output was generated to visually inspect the estimated persistence patterns across individuals. At the end of this phase, the fitted move persistence model provided time-varying movement persistence estimates.

# Phase 5: Data extraction and preparation

In this phase, outputs from the state-space model and the move persistence model were combined into a single dataset. The goal was to move from model-specific objects to a clean latent movement dataset that can used later. 

Predicted locations from the state-space model were used as the spatial backbone of the dataset. These regularized latent locations were then joined with time-varying movement persistence estimates from the move persistence model. For each individual and time point, the dataset includes a unique identifier, timestamp, geographic location, associated location uncertainty, and the estimated movement persistence value.

The resulting dataset represents a regular time series of latent movement states, rather than raw satellite observations. From this point onward, analyses are conducted on this extracted dataset rather than on the original aniMotum model objects. At the end of this phase, a single main analysis table was produced, available both as a tibble and as an sf object, and used as the input for all subsequent visualization and exploratory analyses.

# Phase 6: Mapping and movement visualization

This phase focuses on visualizing reconstructed movement tracks together with movement persistence that highlights large-scale patterns and individual differences. Movement tracks were visualized for individual sharks using faceted maps, with track segments colored by the estimated movement persistence value. A consistent map projection was used across individuals to allow comparison of spatial extent,as well as additional zoomed views for representative sharks.

By coloring tracks with a continuous movement persistence measure, the maps emphasize gradual behavioural variation along trajectories rather than discrete behavioural switching. The mapping outputs from this phase serve primarily as an exploratory and interpretive tool, helping to link reconstructed movement paths with continuous behavioural dynamics.

# Modification

After running the full pipeline, several issues became apparent. In particular, some tracks contained very large temporal gaps, and in a few cases the reconstructed paths crossed over land, which is not physically plausible. Rather than discarding these sharks entirely, I revisited their observation histories and split the tracks into separate segments based on the large gaps. The same modelling pipeline was then applied to each segment independently. This adjustment allowed the reconstructed tracks to remain biologically plausible, while still making use of the available observations as much as possible.